pipeline{

    agent any
    
    tools{
    
	maven 'MAVEN_HOME'
	
	}
    stages{
    
	stage('Upload war to Nexus'){
	
	    steps{
	
		configFileProvider([configFile(fileId: 'm2-global', variable:'MVN_SETTINGS')]) {
		
   		   sh 'mvn -s $MVN_SETTINGS deploy -Dmaven.test.skip=true'
		   
		 }
		 
	     }  
	     
	   }
	   
	stage('upload docker image to nexus'){
	
	   steps{
	   
	   	withCredentials([usernamePassword(credentialsId: 'nexus-creds', passwordVariable: 'pwd', usernameVariable: 'uname')]) {
   	
		sh 'docker build -t ice-cream/flavour:latest .'
		
		sh 'docker tag ice-cream/flavour:latest 01c48b154b60.ngrok.io/ice-cream/flavour:latest'
		
		sh "docker login -u '${uname}' -p '${pwd}' 01c48b154b60.ngrok.io"
		
		sh 'docker push 01c48b154b60.ngrok.io/ice-cream/flavour:latest'
		
		
		
		}
	   	
			
		}
	   }
	   
	   
	   
	stage('Run our own Ice-Cream-Flavour'){
	
	   steps{
	      	
		sh "docker pull 01c48b154b60.ngrok.io/ice-cream/flavour:latest"
		
		sh 'docker stop ice'
		
		sh 'docker rm ice'

	  	sh 'docker run -d -p 8987:8080 --name=ice 01c48b154b60.ngrok.io/ice-cream/flavour:latest'

		sh 'docker ps'
		
		
	   
	   }
	   
	   }
	
	  }
	}


  
    

pipeline{

    agent any
    
    tools{
    
	maven 'MAVEN_HOME'
	
	}
    stages{
    
	stage('Upload war to Nexus'){
	
	    steps{
	
		configFileProvider([configFile(fileId: 'm2-global', variable:'MVN_SETTINGS')]) {
		
   		   sh 'mvn -s $MVN_SETTINGS deploy -Dmaven.test.skip=true'
		   
		 }
		 
	     }  
	     
	   }
	   
	stage('upload docker image to nexus'){
	
	   steps{
	   
	   	withCredentials([usernamePassword(credentialsId: 'nexus-creds', passwordVariable: 'pwd', usernameVariable: 'uname')]) {
   		
    		echo " ${uname} "
		
		sh 'docker build -t ice-cream/flavour:latest .'
		
		sh 'docker tag ice-cream/flavour:latest localhost:8212/ice-cream/flavour:latest'
		
		sh "docker login -u '${uname}' -p '${pwd}' localhost:8212"
		
		sh 'docker push localhost:8212/ice-cream/flavour:latest'
		
		
		
		}
	   	
			
		}
	   }
	   
	   
	   
	stage('Run our own Ice-Cream-Flaour'){
	
	   steps{
	      	
		sh 'docker pull localhost:8212/ice-cream/flavour:latest'

		sh "if [ "$(docker ps -qa -f name=ice)" ]; then"
   		    
		    sh "if [ "$(docker ps -q -f name=ice)" ]; then"
       			
			sh "docker stop ice;"
		    
		    sh "fi"
                       
		    sh "docker rm ice;" 
		
		sh "fi"
		

	  	sh 'docker run -d -p 8987:8080 --name=ice localhost:8212/ice-cream/flavour:latest'


		sh 'docker ps'
		
		
	   
	   }
	   
	   }
	
	  }
	}


  
    
